#!/bin/bash

# Uses qsub to run the genotype demultiplexing via popscle

# top-level directory of cellranger results
# each cellranger directory should be named 10x_scPool_*
CELLRANGER_DIR=...
# command to run demuxlet via popscle binary
RUN_DEMUX=.../popscle-6798538/bin/popscle demuxlet
# vcf of genotypes
VCF=.../TRIGR_merged.filtered.vcf.gz

# working directory
# logs will appear in WORKDIR/log
WORKDIR=...

# genotype demultiplexing result directory
OUTDIR=...

for d in $CELLRANGER_DIR/10x_scPool_00078_*
do
pool=`basename $d`
qsub -pe make 30 -q genome.q -j y -b y -wd ${WORKDIR} -o ${WORKDIR}/log \
  ${RUN_DEMUX} --field GT \
  --sam ${d}/outs/possorted_bam.bam \
  --vcf ${VCF} \
  --group-list ${d}/outs/filtered_peak_bc_matrix/barcodes.tsv \
  --sm 1112580_2-854555.CEL --sm 1110581_2-854584.CEL --sm 1063566_2-854662.CEL --sm 1112527_2-854563.CEL --sm 1110790_2-854590.CEL --sm 1110600_2-854483.CEL --sm 1013103_2-854663.CEL --sm 1012216_2-854664.CEL --sm 1012913_2-854665.CEL --sm 1111257_2-854560.CEL --sm 1110182_2-854597.CEL --sm 1111143_2-854565.CEL --sm 1111050_2-854484.CEL --sm 1110516_2-854573.CEL --sm 1012372_2-854667.CEL --sm 1110014_2-854567.CEL --sm 1021421_2-854668.CEL --sm 1030268_2-854669.CEL --sm TRIGR_1061181 --sm 1112845_2-854569.CEL --sm 1110959_2-854592.CEL --sm 1110132_2-854656.CEL --sm 1110122_2-854583.CEL --sm 1021478_2-854661.CEL --sm 1110784_2-854482.CEL --sm 1111243_2-854654.CEL --sm 1111248_2-854493.CEL --sm 1110797_2-854591.CEL --sm 1110011_2-854564.CEL --sm 1111299_2-854655.CEL --sm 1110821_2-854571.CEL --sm 1110402_2-854491.CEL --sm TRIGR_1045832 --sm TRIGR_1071138 --sm 1012419_2-854666.CEL --sm 1111017_2-854598.CEL --sm 1112605_2-854566.CEL --sm 1110010_2-854568.CEL --sm 1110917_2-854494.CEL --sm 1012582_2-854670.CEL --sm 1110780_2-854596.CEL --sm 1111048_2-854485.CEL --sm 1110941_2-854585.CEL --sm 1110580_2-854486.CEL \
  --out ${OUTDIR}/TRIGR_${pool}.b38.pool.alpha.0.1-0.5.gt
done
for d in $CELLRANGER_DIR/10x_scPool_00079_*
do
pool=`basename $d`
qsub -pe make 30 -q genome.q -j y -b y -wd ${WORKDIR} -o ${WORKDIR}/log \
  ${RUN_DEMUX} --field GT \
  --sam ${d}/outs/possorted_bam.bam \
  --vcf ${VCF} \
  --group-list ${d}/outs/filtered_peak_bc_matrix/barcodes.tsv \
  --sm 1112580_2-854555.CEL --sm 1110581_2-854584.CEL --sm 1063566_2-854662.CEL --sm 1112527_2-854563.CEL --sm 1110790_2-854590.CEL --sm 1110600_2-854483.CEL --sm 1013103_2-854663.CEL --sm 1012216_2-854664.CEL --sm 1012913_2-854665.CEL --sm 1111257_2-854560.CEL --sm 1110182_2-854597.CEL --sm 1111143_2-854565.CEL --sm 1111050_2-854484.CEL --sm 1110516_2-854573.CEL --sm 1012372_2-854667.CEL --sm 1112842_2-854579.CEL --sm 1110014_2-854567.CEL --sm 1021421_2-854668.CEL --sm 1030268_2-854669.CEL --sm 1049580_2-854671.CEL --sm TRIGR_1061181 --sm 1112845_2-854569.CEL --sm 1110959_2-854592.CEL --sm 1110132_2-854656.CEL --sm 1110122_2-854583.CEL --sm 1021478_2-854661.CEL --sm 1110784_2-854482.CEL --sm 1111243_2-854654.CEL --sm 1111248_2-854493.CEL --sm 1110797_2-854591.CEL --sm 1110011_2-854564.CEL --sm 1111299_2-854655.CEL --sm 1110821_2-854571.CEL --sm 1110402_2-854491.CEL --sm TRIGR_1045832 --sm TRIGR_1071138 --sm 1012419_2-854666.CEL --sm 1111017_2-854598.CEL --sm 1112605_2-854566.CEL --sm 1110551_2-854500.CEL --sm 1110010_2-854568.CEL --sm 1110917_2-854494.CEL --sm 1012582_2-854670.CEL --sm 1110333_2-854572.CEL --sm 1110780_2-854596.CEL --sm 1111048_2-854485.CEL --sm 1110941_2-854585.CEL --sm 1110580_2-854486.CEL \
  --out ${OUTDIR}/TRIGR_${pool}.b38.pool.alpha.0.1-0.5.gt
done
for d in $CELLRANGER_DIR/10x_scPool_00080_*
do
pool=`basename $d`
qsub -pe make 30 -q genome.q -j y -b y -wd ${WORKDIR} -o ${WORKDIR}/log \
  ${RUN_DEMUX} --field GT \
  --sam ${d}/outs/possorted_bam.bam \
  --vcf ${VCF} \
  --group-list ${d}/outs/filtered_peak_bc_matrix/barcodes.tsv \
  --sm 1112580_2-854555.CEL --sm 1110581_2-854584.CEL --sm 1063566_2-854662.CEL --sm 1112527_2-854563.CEL --sm 1110790_2-854590.CEL --sm 1110600_2-854483.CEL --sm 1013103_2-854663.CEL --sm 1012216_2-854664.CEL --sm 1012913_2-854665.CEL --sm 1111257_2-854560.CEL --sm 1110182_2-854597.CEL --sm 1111050_2-854484.CEL --sm 1110516_2-854573.CEL --sm 1012372_2-854667.CEL --sm 1112842_2-854579.CEL --sm 1110014_2-854567.CEL --sm 1021421_2-854668.CEL --sm 1030268_2-854669.CEL --sm 1049580_2-854671.CEL --sm TRIGR_1061181 --sm 1112845_2-854569.CEL --sm 1110959_2-854592.CEL --sm 1110132_2-854656.CEL --sm 1112895_2-854580.CEL --sm 1110240_2-854657.CEL --sm 1110291_2-854658.CEL --sm TRIGR_1085671 --sm 1110203_2-854660.CEL --sm 1110489_2-854652.CEL --sm 1110759_2-854581.CEL --sm 1110133_2-854499.CEL --sm 1110736_2-854574.CEL --sm 1112635_2-854559.CEL --sm 1111298_2-854554.CEL --sm 1112835_2-854582.CEL --sm 1110933_2-854556.CEL --sm 1110485_2-854552.CEL --sm 1110823_2-854487.CEL --sm TRIGR_1062514 --sm 1112717_2-854576.CEL --sm 1110282_2-854600.CEL --sm 1110743_2-854557.CEL --sm 1111227_2-854587.CEL --sm TRIGR_1062558 --sm 1110130_2-854651.CEL --sm 1110649_2-854578.CEL --sm 1110005_2-854561.CEL --sm 1110122_2-854583.CEL --sm 1021478_2-854661.CEL --sm 1110784_2-854482.CEL --sm 1111243_2-854654.CEL --sm 1111248_2-854493.CEL --sm 1110797_2-854591.CEL --sm 1110011_2-854564.CEL --sm 1111299_2-854655.CEL --sm 1110821_2-854571.CEL --sm 1110402_2-854491.CEL --sm TRIGR_1045832 --sm 1012419_2-854666.CEL --sm 1111017_2-854598.CEL --sm 1112605_2-854566.CEL --sm 1110551_2-854500.CEL --sm 1110010_2-854568.CEL --sm 1110917_2-854494.CEL --sm 1012582_2-854670.CEL --sm 1110333_2-854572.CEL --sm 1110780_2-854596.CEL --sm 1111048_2-854485.CEL --sm 1110941_2-854585.CEL --sm 1110580_2-854486.CEL --sm 1110537_2-854593.CEL --sm 1111251_2-854551.CEL --sm 1110337_2-854659.CEL --sm 1110729_2-854558.CEL --sm 1110281_2-854599.CEL --sm 1110459_2-854653.CEL --sm 1110771_2-854495.CEL --sm 1111234_2-854589.CEL --sm 1112877_2-854575.CEL --sm 1111155_2-854498.CEL --sm 1110339_2-854490.CEL --sm 1110629_2-854496.CEL --sm 1110935_2-854497.CEL --sm 1110632_2-854594.CEL --sm 1111039_2-854586.CEL --sm 1110488_2-854595.CEL --sm 1111025_2-854488.CEL --sm 1110204_2-854588.CEL --sm 1110008_2-854570.CEL --sm 1110662_2-854489.CEL --sm 1110272_2-854577.CEL --sm 1110836_2-854492.CEL --sm 1110757_2-854553.CEL --sm 1110739_2-854562.CEL \
  --out ${OUTDIR}/TRIGR_${pool}.b38.pool.alpha.0.1-0.5.gt
done
for d in $CELLRANGER_DIR/10x_scPool_00082_*
do
pool=`basename $d`
qsub -pe make 30 -q genome.q -j y -b y -wd ${WORKDIR} -o ${WORKDIR}/log \
  ${RUN_DEMUX} --field GT \
  --sam ${d}/outs/possorted_bam.bam \
  --vcf ${VCF} \
  --group-list ${d}/outs/filtered_peak_bc_matrix/barcodes.tsv \
  --sm 1112895_2-854580.CEL --sm 1110240_2-854657.CEL --sm 1110291_2-854658.CEL --sm TRIGR_1085671 --sm 1110203_2-854660.CEL --sm 1110489_2-854652.CEL --sm 1110759_2-854581.CEL --sm 1110133_2-854499.CEL --sm 1112635_2-854559.CEL --sm 1111298_2-854554.CEL --sm 1051450_2-854672.CEL --sm 1112835_2-854582.CEL --sm 1110485_2-854552.CEL --sm 1110823_2-854487.CEL --sm TRIGR_1062514 --sm 1112717_2-854576.CEL --sm 1110282_2-854600.CEL --sm 1110743_2-854557.CEL --sm 1111227_2-854587.CEL --sm TRIGR_1062558 --sm 1110130_2-854651.CEL --sm 1110649_2-854578.CEL --sm 1110005_2-854561.CEL --sm 1110537_2-854593.CEL --sm 1111251_2-854551.CEL --sm 1110337_2-854659.CEL --sm 1110729_2-854558.CEL --sm 1110281_2-854599.CEL --sm 1110459_2-854653.CEL --sm 1110771_2-854495.CEL --sm 1111234_2-854589.CEL --sm 1111155_2-854498.CEL --sm 1110339_2-854490.CEL --sm 1049966_2-854673.CEL --sm 1110629_2-854496.CEL --sm 1110632_2-854594.CEL --sm 1111039_2-854586.CEL --sm 1110488_2-854595.CEL --sm 1111025_2-854488.CEL --sm 1110204_2-854588.CEL --sm 1110008_2-854570.CEL --sm 1110662_2-854489.CEL --sm 1110272_2-854577.CEL --sm 1110836_2-854492.CEL --sm 1110757_2-854553.CEL --sm 1110739_2-854562.CEL \
  --out ${OUTDIR}/TRIGR_${pool}.b38.pool.alpha.0.1-0.5.gt
done
for d in $CELLRANGER_DIR/10x_scPool_00083_*
do
pool=`basename $d`
qsub -pe make 30 -q genome.q -j y -b y -wd ${WORKDIR} -o ${WORKDIR}/log \
  ${RUN_DEMUX} --field GT \
  --sam ${d}/outs/possorted_bam.bam \
  --vcf ${VCF} \
  --group-list ${d}/outs/filtered_peak_bc_matrix/barcodes.tsv \
  --sm 1112895_2-854580.CEL --sm 1110240_2-854657.CEL --sm 1110291_2-854658.CEL --sm TRIGR_1085671 --sm 1110203_2-854660.CEL --sm 1110489_2-854652.CEL --sm 1110759_2-854581.CEL --sm 1110133_2-854499.CEL --sm 1110736_2-854574.CEL --sm 1112635_2-854559.CEL --sm 1111298_2-854554.CEL --sm 1051450_2-854672.CEL --sm 1112835_2-854582.CEL --sm 1110933_2-854556.CEL --sm 1110485_2-854552.CEL --sm 1110823_2-854487.CEL --sm TRIGR_1062514 --sm 1112717_2-854576.CEL --sm 1110282_2-854600.CEL --sm 1110743_2-854557.CEL --sm 1111227_2-854587.CEL --sm TRIGR_1062558 --sm 1110130_2-854651.CEL --sm 1110005_2-854561.CEL --sm 1110537_2-854593.CEL --sm 1111251_2-854551.CEL --sm 1110337_2-854659.CEL --sm 1110729_2-854558.CEL --sm 1110281_2-854599.CEL --sm 1110459_2-854653.CEL --sm 1110771_2-854495.CEL --sm 1111234_2-854589.CEL --sm 1112877_2-854575.CEL --sm 1111155_2-854498.CEL --sm 1110339_2-854490.CEL --sm 1049966_2-854673.CEL --sm 1110629_2-854496.CEL --sm 1110935_2-854497.CEL --sm 1110632_2-854594.CEL --sm 1111039_2-854586.CEL --sm 1110488_2-854595.CEL --sm 1111025_2-854488.CEL --sm 1110204_2-854588.CEL --sm 1110008_2-854570.CEL --sm 1110662_2-854489.CEL --sm 1110272_2-854577.CEL --sm 1110836_2-854492.CEL --sm 1110739_2-854562.CEL \
  --out ${OUTDIR}/TRIGR_${pool}.b38.pool.alpha.0.1-0.5.gt
done
